class Uv < Formula
  desc "Extremely fast Python package installer and resolver, written in Rust"
  homepage "https://github.com/astral-sh/uv"
  url "https://github.com/astral-sh/uv/archive/refs/tags/0.4.4.tar.gz"
  sha256 "84e5335787086c22cb7ada6508a4034817c91347b65f175c5c04e52dea4362d6"
  license any_of: ["Apache-2.0", "MIT"]
  head "https://github.com/astral-sh/uv.git", branch: "main"

  bottle do
    sha256 cellar: :any_skip_relocation, arm64_sonoma:   "d937d43a8d7704496b10cbd655ad74f020ceab1b787431a148ff2b1e75613a27"
    sha256 cellar: :any_skip_relocation, arm64_ventura:  "55db939c8b7d34fb132d2b18fd1ce0c0b20c5bff61ef5c3acbe2abf41ac3be05"
    sha256 cellar: :any_skip_relocation, arm64_monterey: "59c1674e939acdcdac53138d55ccad9e9e39fba0e2e670536e17a0fa0ea90ac6"
    sha256 cellar: :any_skip_relocation, sonoma:         "4e37b44a103054c06d3f6e627bc14e09680f232db682df20e78482b37e968ed1"
    sha256 cellar: :any_skip_relocation, ventura:        "e08ca35afc9e7757ae6bb08289efffcbcf9ca8d83a0b622f82745facb4f93c57"
    sha256 cellar: :any_skip_relocation, monterey:       "3d08d2751ec6cde100a1a991f7e572f5534955361b18f12de6f954a16f190cad"
    sha256 cellar: :any_skip_relocation, x86_64_linux:   "47f3901a55da14504db839a5c35170f871efbf90fe2aeb675fd4a61072b19fda"
  end

  depends_on "pkg-config" => :build
  depends_on "rust" => :build

  uses_from_macos "python" => :test
  uses_from_macos "xz"

  on_linux do
    # On macOS, bzip2-sys will use the bundled lib as it cannot find the system or brew lib.
    # We only ship bzip2.pc on Linux which bzip2-sys needs to find library.
    depends_on "bzip2"
  end

  def install
    ENV["UV_COMMIT_HASH"] = ENV["UV_COMMIT_SHORT_HASH"] = tap.user
    ENV["UV_COMMIT_DATE"] = time.strftime("%F")
    system "cargo", "install", "--no-default-features", *std_cargo_args(path: "crates/uv")
    generate_completions_from_executable(bin/"uv", "generate-shell-completion")
  end

  test do
    (testpath/"requirements.in").write <<~EOS
      requests
    EOS

    compiled = shell_output("#{bin}/uv pip compile -q requirements.in")
    assert_match "This file was autogenerated by uv", compiled
    assert_match "# via requests", compiled

    assert_match "ruff 0.5.1", shell_output("#{bin}/uvx -q ruff@0.5.1 --version")
  end
end
